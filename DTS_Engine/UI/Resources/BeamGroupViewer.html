<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>DTS Rebar Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' },
                        sky: { 500: '#0ea5e9' },
                    },
                    fontFamily: {
                        mono: ['"Consolas"', '"Menlo"', '"Monaco"', 'monospace'],
                        sans: ['"Inter"', '"Segoe UI"', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .dt-cell {
            position: relative;
        }

        .dt-input {
            background: transparent;
            width: 100%;
            text-align: center;
            font-weight: 600;
            border: none;
            outline: none;
        }

        .dt-input:focus {
            background: #fff;
            box-shadow: 0 0 0 2px #3b82f6 inset;
            border-radius: 2px;
        }

        .status-badge {
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: 700;
        }

        /* Canvas Grid Background */
        .canvas-bg {
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>

<body class="bg-slate-100 h-screen flex flex-col text-slate-800 text-sm overflow-hidden">

    <!-- TOP BAR -->
    <header class="flex-none bg-slate-900 text-white shadow-lg z-50 h-12 flex items-center justify-between px-4">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-cube text-sky-500 text-lg"></i>
                <span class="font-bold tracking-wide">DTS</span>
                <span class="text-slate-400 text-xs uppercase tracking-wider border-l border-slate-700 pl-2 ml-1">Rebar
                    Engine</span>
            </div>

            <!-- Group Navigator -->
            <div class="flex items-center bg-slate-800 rounded p-0.5 ml-4">
                <button onclick="prevGroup()" class="px-2 hover:text-sky-400 transition"><i
                        class="fa-solid fa-chevron-left"></i></button>
                <select id="groupSelect" onchange="loadGroup(this.value)"
                    class="bg-transparent border-none text-xs font-medium px-2 py-1 outline-none w-48 text-center cursor-pointer"></select>
                <button onclick="nextGroup()" class="px-2 hover:text-sky-400 transition"><i
                        class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="flex items-center gap-3">
            <div class="flex items-center bg-slate-800 rounded px-2 py-1 gap-2">
                <span class="text-xs text-slate-400">Design:</span>
                <select id="optionSelect" onchange="selectOption(this.value)"
                    class="bg-transparent text-xs outline-none w-32"></select>
                <button id="lockBtn" onclick="lockDesign()" class="text-sky-500 hover:text-white transition"><i
                        class="fa-solid fa-lock"></i></button>
            </div>

            <div class="h-6 w-px bg-slate-700"></div>

            <button onclick="toggleHighlightMode()" id="highlightBtn"
                class="text-slate-400 hover:text-white text-xs flex items-center gap-1 transition">
                <i class="fa-regular fa-eye"></i> Highlight CAD
            </button>
        </div>
    </header>

    <!-- METRICS DASHBOARD -->
    <div class="flex-none bg-white border-b border-slate-200 px-6 py-3 flex items-center justify-between">
        <div class="flex gap-8">
            <div class="flex flex-col">
                <span class="text-[10px] text-slate-400 uppercase font-bold">Backbone</span>
                <span id="metricBackbone" class="font-bold text-slate-700 text-lg leading-tight">-</span>
            </div>
            <div class="flex flex-col">
                <span class="text-[10px] text-slate-400 uppercase font-bold">Total Steel</span>
                <span id="metricWeight" class="font-bold text-slate-700 text-lg leading-tight">-</span>
            </div>
            <div class="flex flex-col">
                <span class="text-[10px] text-slate-400 uppercase font-bold">Efficiency</span>
                <span id="metricScore" class="font-bold text-emerald-600 text-lg leading-tight">-</span>
            </div>
            <div class="flex flex-col">
                <span class="text-[10px] text-slate-400 uppercase font-bold">Waste</span>
                <span id="metricWaste" class="font-bold text-amber-600 text-lg leading-tight">-</span>
            </div>
        </div>

        <div id="warningsContainer" class="flex gap-2"></div>
    </div>

    <!-- MAIN CONTENT GRID -->
    <main class="flex-1 flex flex-col overflow-hidden">
        <!-- CANVAS -->
        <div class="flex-none h-[220px] canvas-bg relative border-b border-slate-200 overflow-hidden"
            id="canvasContainer">
            <canvas id="beamCanvas"></canvas>
            <!-- Overlay Controls -->
            <div class="absolute top-2 right-2 bg-white/90 backdrop-blur rounded shadow p-1 flex gap-1 z-10">
                <button onclick="fitView()" class="p-1 hover:bg-slate-100 rounded text-slate-600" title="Fit to View"><i
                        class="fa-solid fa-expand"></i></button>
            </div>
        </div>

        <!-- ENGINEERING DATA GRID -->
        <div class="flex-1 overflow-auto bg-slate-50 p-4">
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                <table class="w-full text-xs border-collapse">
                    <thead class="bg-slate-100 text-slate-500 font-semibold sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th rowspan="2" class="p-3 text-left w-16 border-r border-slate-200 bg-slate-100">Span</th>
                            <th rowspan="2" class="p-3 text-center w-20 border-r border-slate-200 bg-slate-100">
                                Section<br><span class="text-[10px] font-normal">(mm)</span></th>
                            <th colspan="3"
                                class="p-2 text-center border-r border-slate-200 border-b bg-red-50 text-red-600">TOP
                                REINFORCEMENT</th>
                            <th colspan="3"
                                class="p-2 text-center border-r border-slate-200 border-b bg-blue-50 text-blue-600">
                                BOTTOM REINFORCEMENT</th>
                            <th rowspan="2" class="p-3 text-center w-24 bg-slate-100">Stirrups</th>
                        </tr>
                        <tr>
                            <!-- TOP headers -->
                            <th class="p-2 w-32 border-r border-slate-200 bg-red-50/50">Left Support</th>
                            <th class="p-2 w-32 border-r border-slate-200 bg-red-50/50">Mid Span</th>
                            <th class="p-2 w-32 border-r border-slate-200 bg-red-50/50">Right Support</th>
                            <!-- BOT headers -->
                            <th class="p-2 w-32 border-r border-slate-200 bg-blue-50/50">Left Support</th>
                            <th class="p-2 w-32 border-r border-slate-200 bg-blue-50/50">Mid Span</th>
                            <th class="p-2 w-32 border-r border-slate-200 bg-blue-50/50">Right Support</th>
                        </tr>
                    </thead>
                    <tbody id="gridBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- FOOTER ACTIONS -->
    <footer
        class="flex-none bg-white border-t border-slate-200 px-6 py-3 flex justify-between items-center z-20 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded">
                <i class="fa-solid fa-circle-info"></i>
                <span id="groupInfo">Total: -</span>
            </div>
            <!-- Legend -->
            <div class="flex items-center gap-2 text-[10px] ml-4">
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span>OK</span>
                <span class="flex items-center gap-1"><span
                        class="w-2 h-2 rounded-full bg-red-500"></span>Missing</span>
                <span class="flex items-center gap-1"><span
                        class="w-2 h-2 rounded-full bg-amber-500"></span>Excess</span>
            </div>
        </div>

        <div class="flex gap-3">
            <button onclick="doCancel()"
                class="px-4 py-2 rounded text-slate-600 font-medium hover:bg-slate-100 transition text-xs">Cancel</button>
            <button onclick="applyToDrawing()"
                class="px-6 py-2 rounded bg-sky-600 hover:bg-sky-500 text-white font-bold shadow-md shadow-sky-200 transition text-xs flex items-center gap-2">
                <i class="fa-solid fa-check"></i> Apply to Drawing
            </button>
        </div>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA STATE ---
        const data = __DATA_JSON__;
        let currentGroup = null;
        let currentGroupIndex = 0;
        let spanBounds = [];
        let highlightMode = false;

        // --- CONSTANTS ---
        const BAR_AREAS = {
            6: 0.28, 8: 0.50, 10: 0.79, 12: 1.13, 14: 1.54,
            16: 2.01, 18: 2.54, 20: 3.14, 22: 3.80, 25: 4.91,
            28: 6.16, 30: 7.07, 32: 8.04
        };
        // Rebar regex: "2D20", "2d20", "2T20"
        const REBAR_REGEX = /^(\d+)[DT](\d+)$/i;

        // --- INITIALIZATION ---
        function init() {
            populateGroupSelect();
            if (data.groups?.length > 0) loadGroup(0);

            // Listen for window resize to refit canvas
            window.addEventListener('resize', () => {
                requestAnimationFrame(renderCanvas);
            });
        }

        // --- GROUP LOADING ---
        function populateGroupSelect() {
            const sel = document.getElementById('groupSelect');
            sel.innerHTML = '';
            data.groups?.forEach((g, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = `${g.GroupName} (${g.GroupType === 'Girder' ? 'G' : 'B'})`;
                sel.appendChild(opt);
            });
        }

        function loadGroup(idx) {
            currentGroupIndex = parseInt(idx);
            currentGroup = data.groups[currentGroupIndex];
            document.getElementById('groupSelect').value = currentGroupIndex;

            populateOptionSelect();
            updateMetrics();
            updateGroupInfo();
            renderCanvas();
            renderGrid();
        }

        function prevGroup() { if (currentGroupIndex > 0) loadGroup(currentGroupIndex - 1); }
        function nextGroup() { if (currentGroupIndex < data.groups.length - 1) loadGroup(currentGroupIndex + 1); }

        // --- METRICS ---
        function updateMetrics() {
            if (!currentGroup) return;
            const opt = currentGroup.BackboneOptions?.[currentGroup.SelectedBackboneIndex || 0];

            document.getElementById('metricBackbone').textContent = opt ? opt.OptionName : '-';
            document.getElementById('metricWeight').textContent = opt ? (opt.TotalSteelWeight?.toFixed(0) + ' kg') : '-';
            document.getElementById('metricScore').textContent = opt ? opt.EfficiencyScore?.toFixed(0) : '-';
            document.getElementById('metricWaste').textContent = opt ? (opt.WastePercentage?.toFixed(1) + '%') : '-';

            // Warnings
            const warnings = [];
            if (currentGroup.HasStepChange) warnings.push({ t: 'Step Change', c: 'bg-amber-100 text-amber-700' });
            if (currentGroup.RequiresSplice) warnings.push({ t: 'Splice', c: 'bg-blue-100 text-blue-700' });

            document.getElementById('warningsContainer').innerHTML = warnings.map(w =>
                `<span class="px-2 py-1 rounded text-xs font-bold ${w.c}">${w.t}</span>`
            ).join('');
        }

        function updateGroupInfo() {
            if (!currentGroup) return;
            document.getElementById('groupInfo').textContent = `Length: ${currentGroup.TotalLength?.toFixed(1)}m | Beams: ${currentGroup.EntityHandles?.length}`;
        }

        // --- CANVAS RENDERING (Auto Scale) ---
        function renderCanvas() {
            if (!currentGroup?.Spans) return;
            const cvs = document.getElementById('beamCanvas');
            const ctx = cvs.getContext('2d');
            const container = document.getElementById('canvasContainer');

            cvs.width = container.clientWidth;
            cvs.height = container.clientHeight;

            const W = cvs.width;
            const H = cvs.height;
            const PADDING_X = 50;
            const PADDING_Y = 60;

            // Clear
            ctx.clearRect(0, 0, W, H);

            // Scale calc
            const totalLen = currentGroup.TotalLength;
            if (totalLen <= 0) return;

            const scalePxPerM = (W - 2 * PADDING_X) / totalLen;
            const beamH = 60; // Fixed visual height
            const beamY = H / 2 - beamH / 2;

            let currentX = PADDING_X;
            spanBounds = [];

            currentGroup.Spans.forEach((span, i) => {
                const w = span.Length * scalePxPerM;

                // Draw Beam Body
                ctx.fillStyle = '#e2e8f0';
                ctx.strokeStyle = '#94a3b8';
                ctx.lineWidth = 1;
                ctx.fillRect(currentX, beamY, w, beamH);
                ctx.strokeRect(currentX, beamY, w, beamH);

                // Draw Rebar (Schematic)
                drawRebarSchematic(ctx, currentX, beamY, w, beamH, span);

                // Supports
                ctx.fillStyle = '#475569';
                ctx.beginPath();
                ctx.moveTo(currentX, beamY + beamH);
                ctx.lineTo(currentX - 5, beamY + beamH + 10);
                ctx.lineTo(currentX + 5, beamY + beamH + 10);
                ctx.fill();

                // Labels
                ctx.fillStyle = '#1e293b';
                ctx.font = 'bold 12px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(span.SpanId, currentX + w / 2, beamY + beamH / 2 + 4);

                // Dimensions
                ctx.fillStyle = '#64748b';
                ctx.font = '10px Inter';
                ctx.fillText(`${span.Length.toFixed(2)}m`, currentX + w / 2, beamY - 8);

                // Store Map
                spanBounds.push({ x: currentX, w: w, idx: i });

                currentX += w;
            });

            // Last support
            ctx.fillStyle = '#475569';
            ctx.beginPath();
            ctx.moveTo(currentX, beamY + beamH);
            ctx.lineTo(currentX - 5, beamY + beamH + 10);
            ctx.lineTo(currentX + 5, beamY + beamH + 10);
            ctx.fill();
        }

        function drawRebarSchematic(ctx, x, y, w, h, span) {
            // Simplified red/blue lines
            const topY = y + 10;
            const botY = y + h - 10;

            // Top
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(x, topY); ctx.lineTo(x + w, topY); ctx.stroke();

            // Bot
            ctx.strokeStyle = '#3b82f6';
            ctx.beginPath(); ctx.moveTo(x, botY); ctx.lineTo(x + w, botY); ctx.stroke();
        }

        // --- GRID RENDERING (The Core) ---
        function renderGrid() {
            const tbody = document.getElementById('gridBody');
            tbody.innerHTML = '';

            currentGroup.Spans.forEach((span, i) => {
                // Determine Row State
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors group ' + (i % 2 === 0 ? 'bg-white' : 'bg-slate-50/50');

                // Cells
                let html = `
                    <td class="p-3 font-bold text-slate-700 border-r border-slate-100">${span.SpanId}</td>
                    <td class="p-3 text-center text-slate-600 border-r border-slate-100 font-mono text-xs">
                        ${Math.round(span.Width)}x${Math.round(span.Height)}
                    </td>
                `;

                // --- TOP REBAR (3 positions) ---
                const pos = [0, 2, 4]; // Left, Mid, Right
                pos.forEach(p => {
                    const reqArea = span.As_Top?.[p] || 0;
                    const rebarStr = span.TopRebar?.[0]?.[p] || '';
                    html += renderRebarCell(i, 'Top', p, reqArea, rebarStr, 'bg-red-50/30');
                });

                // --- BOT REBAR (3 positions) ---
                pos.forEach(p => {
                    const reqArea = span.As_Bot?.[p] || 0;
                    const rebarStr = span.BotRebar?.[0]?.[p] || '';
                    html += renderRebarCell(i, 'Bot', p, reqArea, rebarStr, 'bg-blue-50/30');
                });

                // --- STIRRUPS ---
                html += `<td class="p-2 border-l border-slate-200">
                    <input type="text" value="${span.Stirrup?.[0] || ''}" onchange="updateStirrup(${i}, this.value)"
                    class="w-full text-center text-[10px] text-slate-500 bg-transparent outline-none border border-transparent focus:border-blue-300 rounded">
                </td>`;

                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }

        function renderRebarCell(spanIdx, type, pos, req, str, bgClass) {
            // Calc Provided
            const prov = calculateRebarArea(str);
            const ratio = req > 0 ? (prov / req) : 1.0;
            const isMissing = prov < req && req > 0.1;
            const isExcess = prov > req * 1.5 && prov > 2.0; // Avoid alerting small bars

            // Status Color
            let statusColor = 'text-slate-400';
            let statusIcon = '';
            if (isMissing) { statusColor = 'text-red-500'; statusIcon = '<i class="fa-solid fa-triangle-exclamation"></i>'; }
            else if (isExcess) { statusColor = 'text-amber-500'; statusIcon = '<i class="fa-solid fa-arrow-up"></i>'; }
            else if (req > 0) { statusColor = 'text-emerald-500'; statusIcon = '<i class="fa-solid fa-check"></i>'; }

            return `
                <td class="p-2 border-r border-slate-100 ${bgClass} dt-cell align-top">
                    <div class="flex flex-col items-center gap-1">
                        <!-- Input -->
                        <input type="text" value="${str}" 
                            onchange="updateRebar(${spanIdx}, '${type}', ${pos}, this.value)"
                            class="dt-input font-mono text-sm ${isMissing ? 'text-red-600 font-bold' : 'text-slate-700'}">
                        
                        <!-- Mini Stats -->
                        <div class="flex items-center justify-between w-full px-2 mt-1">
                            <div class="flex flex-col items-start leading-none">
                                <span class="text-[9px] text-slate-400 uppercase tracking-tighter">Req</span>
                                <span class="text-[10px] font-bold text-slate-600">${req.toFixed(2)}</span>
                            </div>
                            
                            <div class="${statusColor} text-[10px]">${statusIcon}</div>

                            <div class="flex flex-col items-end leading-none">
                                <span class="text-[9px] text-slate-400 uppercase tracking-tighter">Prov</span>
                                <span class="text-[10px] font-bold ${isMissing ? 'text-red-600' : 'text-slate-600'}">${prov.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </td>
            `;
        }

        // --- MATH HELPERS ---
        function calculateRebarArea(str) {
            // str ex: "3D20", "2d18+1d20"
            if (!str) return 0;
            let total = 0;
            // Split by +
            const parts = str.split('+');
            parts.forEach(p => {
                const match = p.trim().match(REBAR_REGEX);
                if (match) {
                    const count = parseInt(match[1]);
                    const dia = parseInt(match[2]);
                    if (BAR_AREAS[dia]) total += count * BAR_AREAS[dia];
                }
            });
            return total;
        }

        // --- INTERACTIONS ---
        function updateRebar(spanIdx, type, pos, val) {
            const arr = type === 'Top' ? 'TopRebar' : 'BotRebar';
            if (!currentGroup.Spans[spanIdx][arr]) currentGroup.Spans[spanIdx][arr] = [[], [], []];
            if (!currentGroup.Spans[spanIdx][arr][0]) currentGroup.Spans[spanIdx][arr][0] = [];
            currentGroup.Spans[spanIdx][arr][0][pos] = val;

            // Re-render only that cell? For now full render
            renderGrid();
            renderCanvas();
        }

        function populateOptionSelect() {
            // Reuse logic from old viewer for options
            const sel = document.getElementById('optionSelect');
            sel.innerHTML = '';
            if (currentGroup.BackboneOptions) {
                currentGroup.BackboneOptions.forEach((opt, i) => {
                    const el = document.createElement('option');
                    el.value = i;
                    el.textContent = opt.OptionName || `Option ${i + 1}`;
                    sel.appendChild(el);
                });
            }
        }

        function selectOption(val) {
            // Logic to switch option
            // Update spans rebar from option...
            // For brevity, skipping full implementation here, assume similar to old viewer
            // Ideally we copy Backbone to Spans here using JS
        }

        function applyToDrawing() {
            window.chrome.webview?.postMessage('APPLY_DRAWING|' + JSON.stringify(currentGroup));
        }

        function doCancel() {
            window.chrome.webview?.postMessage('CANCEL');
        }

        // Start
        window.onload = init;

    </script>
</body>

</html>